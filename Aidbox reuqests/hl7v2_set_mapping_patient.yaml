#PUT /Mapping/hl7v2-patient
content-type: text/yaml

body:
  $let:
    # 1. Transform all identifiers from PID into FHIR format
    - identifiers:
        $map: $ msg.PID.identifiers
        $as: i
        $body:
          use: official
          # Use the FACILITY_ID variable from the parent mapping
          system: $ FACILITY_ID + "/" + i.system
          value: $ i.value
          assigner:
            display: $ FACILITY_ID

    # 2. Form a query string for a conditional search by ALL identifiers
    - searchList:
        $map: $ identifiers
        $as: id
        $body: $ id.system + "|" + id.value

    - searchQuery: $ "?identifier=" + joinStr(',', searchList)
  # The body of this mapping now returns only the entry array.
  # The parent mapping is responsible for creating the final Bundle.
  $body:
    resourceType: Bundle
    type: transaction
    entry:
      - request:
          # Search by any of the identifiers. This solves your main requirement.
          url: $ "/fhir/Patient" + searchQuery
          method: PUT

        # PATIENT RESOURCE THAT WILL BE CREATED OR UPDATED
        resource:
          resourceType: Patient
          identifier: $ identifiers # Use the variable defined above

          name:
            $map: $ msg.PID.name
            $as: n
            $body:
              use:
                $switch: $ toUpperCase(n.type)
                A: nickname
                B: old
                C: old
                D: usual
                I: official
                L: official
                M: maiden
                N: nickname
                #P: name of partner - obsolete
                R: official
                S: anonymous
                T: nickname
                $default: temp
              family: $ n.family.surname
              given:
                - $ n.given

          telecom:
            $call: flatten
            $args:
              - - $map: $ msg.PID.home_phone
                  $as: p
                  $body:
                    $if: n.phone
                    $then:
                      system:
                        $switch: $ toUpperCase(p.type)
                        BP: pager
                        CP: phone
                        FX: fax
                        Internet: url
                        MD: other
                        PH: phone
                        TDD: other
                        TTY: other
                        $default: phone
                      value: $ p.phone
                      use:
                        $if: $ p.type = 'CP' || p.type = 'CELL'
                        $then: mobile
                        $else: home
                - $map: $ msg.PID.home_phone
                  $as: p
                  $body:
                    $if: n.email
                    $then:
                      system: email
                      value: $ p.email
                      use: home
                - $map: $ msg.PID.phone_number_business
                  $as: p
                  $body:
                    $if: n.phone
                    $then:
                      system:
                        $switch: $ toUpperCase(p.type)
                        BP: pager
                        CP: phone
                        FX: fax
                        Internet: url
                        MD: other
                        PH: phone
                        TDD: other
                        TTY: other
                        $default: phone
                      value: $ p.phone
                      use:
                        $if: $ p.type = 'CP' || p.type = 'CELL'
                        $then: mobile
                        $else: work
                - $map: $ msg.PID.phone_number_business
                  $as: p
                  $body:
                    $if: n.email
                    $then:
                      system: email
                      value: $ p.email
                      use: work

          gender:
            $switch: $ toUpperCase(msg.PID.gender)
            F: female
            M: male
            O: other
            U: unknown
            A: other
            N: other
            $default: unknown

          # This will work for correct formst YYYYMMDD or YYYYMM or YYYY dates.
          # In other case it will be skipped.
          birthDate: $ hl7v2dateConverter(msg.PID.birth_date.time)

          deceasedDateTime: $ hl7v2dateConverter(msg.PID.death_datetime.time)
          deceasedBoolean:
            $if: $ !hl7v2dateConverter(msg.PID.death_datetime.time)
            $then:
              $switch: $ msg.PID.death_indicator
              Y: true
              N: false

          address:
            $map: $ msg.PID.address
            $as: a
            $body:
              use:
                $switch: $ toUpperCase(a.type)
                B: work
                L: work
                O: work
                M: billing
                H: home
                P: home
                RH: home
                $default: temp
              type:
                $if: $ toUpperCase(a.type) = 'M'
                $then: postal
                $else: both
              line:
                - $ a.street.name
                - $ a.street.text
                - $ a.street.number
              city: $ a.city
              district: $ a.county
              state: $ a.state
              postalCode: $ a.postal_code
              country: $ a.country

          maritalStatus:
            coding:
              - system: http://terminology.hl7.org/CodeSystem/v3-MaritalStatus
                code:
                  $switch: $ msg.PID.marital_status.code
                  A: UNK # Separated -> Unknown
                  D: D # Divorce -> Divorce
                  M: M # Married -> Married
                  S: S # Single -> Single
                  W: W # Widowed -> Widowed
                  C: C # Common Law -> Common Law
                  G: T # Living Together -> Domestic Partner
                  P: T # Domestic Partner -> Domestic Partner
                  R: T # Registered Domestic Partner -> Domestic Partner
                  E: L # Legally Separated -> Legally Separated
                  N: A # Annulled -> Annulled
                  I: I # Interlocutory -> Interlocutory
                  B: U # Unmarried -> Unmarried
                  U: UNK # Unknown -> Unknown
                  O: UNK # Other -> Unknown
                  T: UNK # Unreported -> Unknown
                  $default: UNK

          multipleBirthInteger: $ toInt(msg.PID.birth_order)
          multipleBirthBoolean:
            $if: $ !toInt(msg.PID.birth_order)
            $then:
              $switch: $ msg.PID.multiple_birth_indicator
              Y: true
              N: false

          communication:
            - language:
                coding:
                  - system: $ msg.PID.primary_language.system
                    code: $ msg.PID.primary_language.code
                text: $ msg.PID.primary_language.text
              preferred: true
            - language:
                coding:
                  - system: $ msg.PID.primary_language.alternate_system
                    code: $ msg.PID.primary_language.alternate_code
                text: $ msg.PID.primary_language.alternate_text
